# VidCleanser

批量去除视频水印工具，基于 IOPaint/LaMa 的 HTTP API 实现自动化的视频水印去除。

## 功能特性

- 🔍 **自动监控**：监控输入目录，发现新的 .mp4 文件自动入队处理
- 🎯 **固定掩码**：直接使用配置文件中指定的掩码文件
- ⚡ **高效处理**：视频级串行处理，帧级并行修复
- 🛡️ **稳定可靠**：失败自动清理，不保留中间文件
- 📝 **详细日志**：完整的处理日志和状态监控
- 🎨 **灵活掩码**：支持任意尺寸视频，使用统一的掩码文件
- ⏰ **时间戳命名**：输出文件自动添加时间戳，避免文件名冲突

## 项目结构

```
VidCleanser/
├── main.py                 # 程序入口
├── watcher.py              # 目录轮询与任务队列
├── processor.py            # 单视频处理管线
├── api_client.py           # IOPaint API 调用封装
├── ffmpeg_utils.py         # FFmpeg 工具封装
├── config.py               # 配置管理
├── utils.py                # 公共工具函数
├── requirements.txt        # 依赖包
├── config.yaml             # 配置文件
├── lama_install.md         # LaMa 安装配置指南
├── logs/                   # 日志文件目录
│   └── app.log             # 程序运行日志
└── README.md               # 使用说明
```

## 安装依赖

### 1. 安装 Python 依赖

```bash
pip install -r requirements.txt
```

### 2. 安装 FFmpeg

**Windows:**
1. 下载 FFmpeg: https://ffmpeg.org/download.html
2. 解压到任意目录（如 `C:\ffmpeg`）
3. 将 `C:\ffmpeg\bin` 添加到系统 PATH 环境变量

**验证安装:**
```bash
ffmpeg -version
ffprobe -version
```

### 3. 安装和启动 IOPaint 服务

**重要**：VidCleanser 需要配合 IOPaint/LaMa 服务才能正常工作。

#### 快速启动（如果已安装）
```bash
iopaint start --model lama --device cuda --port 8080
```

#### 完整安装指南
如果尚未安装 IOPaint/LaMa，请参考详细的安装配置文档：

👉 **[lama_install.md](./lama_install.md)** - LaMa 完整安装配置指南

该文档包含：
- Python 3.11 环境配置
- 虚拟环境创建
- IOPaint 安装
- GPU 版 PyTorch 配置
- 服务启动和验证
- WebUI 和 API 测试

**注意**：确保按照文档完成所有步骤，特别是 GPU 配置，以获得最佳性能。

## 配置说明

编辑 `config.yaml` 文件：

```yaml
# 输入目录（扫描 .mp4 文件，仅第一层）
input_dir: "E:/videos_in"

# 输出目录（清理后的视频保存位置）
output_dir: "E:/videos_out"

# 临时工作目录（处理过程中的临时文件）
temp_dir: "E:/videos_temp"

# IOPaint LaMa API 地址
lama_api_url: "http://127.0.0.1:8080/api/v1/inpaint"

# 帧级 LaMa 并行数（建议 2-4）
api_workers: 3

# 轮询扫描间隔（秒）
scan_interval_sec: 10

# 日志级别：debug/info/warn/error
log_level: "info"

# 固定掩码文件路径
mask_path: "E:/videos_in/jimeng_mask.png"
```

### 掩码文件配置

- **mask_path**：指定掩码文件的完整路径
- 掩码文件应该是PNG格式的灰度图像
- 白色区域表示需要去除的水印区域
- 黑色区域表示保留的原始内容
- 掩码文件不会被程序删除，可以重复使用

## 使用方法

### 1. 监控模式（推荐）

自动监控输入目录，发现新视频自动处理：

```bash
python main.py
```

### 2. 处理单个视频

```bash
python main.py --video "path/to/video.mp4"
```

### 3. 验证环境

```bash
python main.py --validate
```

### 4. 查看状态

```bash
python main.py --status
```

### 5. 使用自定义配置

```bash
python main.py --config "my_config.yaml"
```

## 处理流程

1. **监控扫描**：每 10 秒扫描一次输入目录（仅第一层）
2. **视频入队**：发现新的 .mp4 文件自动加入处理队列
3. **串行处理**：严格按顺序处理，一次只处理一个视频
4. **掩码加载**：直接使用配置文件中指定的掩码文件
5. **帧提取**：将视频拆分为帧序列
6. **并行修复**：使用 LaMa API 并行修复所有帧
7. **视频合成**：将修复后的帧合成为新视频（添加时间戳）
8. **清理完成**：删除原视频和中间文件，保留清理后的视频

## 处理策略

- **视频级串行**：确保系统稳定性，避免资源冲突
- **帧级并行**：提高处理效率，充分利用 API 并发能力
- **固定掩码**：直接使用配置文件中指定的掩码文件，无需判断
- **灵活适配**：支持任意尺寸视频，使用统一的掩码文件
- **失败清理**：处理失败时自动清理工作目录，保留原视频
- **无断点续跑**：失败后重新开始，确保处理完整性

## 日志文件

程序运行日志保存在 `logs/app.log`，包含：
- 处理开始/结束时间
- 使用的掩码文件路径
- 处理帧数和耗时
- 成功/失败状态
- 错误详情

## 注意事项

1. **IOPaint 服务必需**：程序启动前必须先启动 IOPaint 服务，参考 [lama_install.md](./lama_install.md) 进行安装配置
2. **FFmpeg 可用性**：确保 FFmpeg 和 FFprobe 在系统 PATH 中
3. **磁盘空间**：处理过程中需要足够的临时空间存储帧文件
4. **网络连接**：确保能够访问 IOPaint API 服务
5. **文件权限**：确保对输入/输出目录有读写权限
6. **掩码文件**：确保配置的掩码文件存在且可读
7. **GPU 推荐**：建议使用 GPU 加速，CPU 模式处理速度较慢

## 故障排除

### 1. FFmpeg 不可用
```
错误: FFmpeg 或 FFprobe 不可用
解决: 安装 FFmpeg 并添加到 PATH 环境变量
```

### 2. API 连接失败
```
错误: 无法连接到 IOPaint API
解决: 确保 IOPaint 服务已启动，检查端口和地址配置
参考: 按照 lama_install.md 重新安装和配置 IOPaint 服务
```

### 3. 视频处理失败
```
错误: 视频处理失败
解决: 检查视频文件是否损坏，查看详细日志了解具体错误
```

### 4. LaMa 服务问题
```
错误: LaMa 服务启动失败或处理异常
解决: 
1. 检查 Python 3.11 是否正确安装
2. 确认虚拟环境已激活
3. 验证 PyTorch GPU 版本是否正确安装
4. 参考 lama_install.md 重新配置环境
5. 检查 GPU 驱动和 CUDA 版本兼容性
```

### 5. 权限问题
```
错误: 无法创建输出目录
解决: 检查目录权限，确保程序有写入权限
```

## 性能优化

1. **调整并发数**：根据系统性能调整 `api_workers` 参数
2. **调整扫描间隔**：根据视频产生频率调整 `scan_interval_sec`
3. **使用 SSD**：将临时文件存储在 SSD 上可显著提高处理速度
4. **固定掩码**：直接使用配置的掩码文件，跳过所有检测步骤
5. **简化流程**：移除复杂的类型识别和验证逻辑，提高处理效率

## 掩码文件说明

### 掩码文件要求

- **格式**：PNG 格式的灰度图像
- **内容**：白色区域表示需要去除的水印，黑色区域表示保留内容
- **尺寸**：建议与目标视频分辨率一致，但API会自动适配
- **位置**：通过 `config.yaml` 中的 `mask_path` 配置

### 掩码文件制作

1. **创建灰度图像**：使用图像编辑软件创建与视频同尺寸的PNG文件
2. **标记水印区域**：将需要去除的水印区域涂成白色
3. **保留其他区域**：将不需要处理的区域保持黑色
4. **保存文件**：保存为PNG格式，放置在指定路径

### 使用优势

- ✅ **简单直接**：无需复杂的检测和判断逻辑
- ✅ **灵活适配**：支持任意尺寸和类型的视频
- ✅ **高效处理**：跳过所有验证步骤，直接使用
- ✅ **可重复使用**：掩码文件不会被删除，可重复使用

## 技术栈

- **Python 3.8+**
- **Requests**: HTTP API 调用
- **FFmpeg**: 视频处理
- **IOPaint/LaMa**: AI 图像修复

## 处理时间估算

### 典型视频处理时间：

#### 5秒视频 (约120-150帧)：
- **帧提取**: ~2-3秒
- **帧修复**: ~30-80秒 (3并发)
- **视频合成**: ~3-4秒
- **总计**: ~35-87秒

### 性能优势：

- ✅ **跳过检测**: 无需抽帧和检测，直接处理
- ✅ **固定掩码**: 直接使用配置的掩码文件，加载速度快
- ✅ **简化流程**: 移除复杂的类型识别和验证逻辑
- ✅ **并发处理**: LaMa API 支持多线程并行修复

## 许可证

本项目仅供学习和研究使用。
