# VidCleanser

批量去除视频水印工具，基于 IOPaint/LaMa 的 HTTP API 实现自动化的视频水印去除。

## 功能特性

- 🔍 **自动监控**：监控输入目录，发现新的 .mp4 文件自动入队处理
- 🎯 **固定掩码**：基于视频分辨率自动选择预生成的精确掩码
- ⚡ **高效处理**：视频级串行处理，帧级并行修复
- 🛡️ **稳定可靠**：失败自动清理，不保留中间文件
- 📝 **详细日志**：完整的处理日志和状态监控
- 🎨 **精确掩码**：支持即梦和可灵两种视频类型的专用掩码
- ⏰ **时间戳命名**：输出文件自动添加时间戳，避免文件名冲突

## 项目结构

```
VidCleanser/
├── main.py                 # 程序入口
├── watcher.py              # 目录轮询与任务队列
├── processor.py            # 单视频处理管线
├── mask_fixed.py           # 固定掩码管理
├── api_client.py           # IOPaint API 调用封装
├── ffmpeg_utils.py         # FFmpeg 工具封装
├── config.py               # 配置管理
├── utils.py                # 公共工具函数
├── masks/                  # 固定掩码文件
│   ├── jimeng_mask.png     # 即梦视频掩码 (832×1120)
│   └── kling_mask.png      # 可灵视频掩码 (1152×1760)
├── requirements.txt        # 依赖包
├── config.yaml             # 配置文件
└── README.md               # 使用说明
```

## 安装依赖

### 1. 安装 Python 依赖

```bash
pip install -r requirements.txt
```

### 2. 安装 FFmpeg

**Windows:**
1. 下载 FFmpeg: https://ffmpeg.org/download.html
2. 解压到任意目录（如 `C:\ffmpeg`）
3. 将 `C:\ffmpeg\bin` 添加到系统 PATH 环境变量

**验证安装:**
```bash
ffmpeg -version
ffprobe -version
```

### 3. 启动 IOPaint 服务

```bash
iopaint start --model lama --device cuda --port 8080
```

## 配置说明

编辑 `config.yaml` 文件：

```yaml
# 输入目录（扫描 .mp4 文件，仅第一层）
input_dir: "E:/videos_in"

# 输出目录（清理后的视频保存位置）
output_dir: "E:/videos_out"

# 临时工作目录（处理过程中的临时文件）
temp_dir: "E:/videos_temp"

# IOPaint LaMa API 地址
lama_api_url: "http://127.0.0.1:8080/api/v1/inpaint"

# 帧级 LaMa 并行数（建议 2-4）
api_workers: 3

# 轮询扫描间隔（秒）
scan_interval_sec: 10

# 日志级别：debug/info/warn/error
log_level: "info"
```

## 使用方法

### 1. 监控模式（推荐）

自动监控输入目录，发现新视频自动处理：

```bash
python main.py
```

### 2. 处理单个视频

```bash
python main.py --video "path/to/video.mp4"
```

### 3. 验证环境

```bash
python main.py --validate
```

### 4. 查看状态

```bash
python main.py --status
```

### 5. 使用自定义配置

```bash
python main.py --config "my_config.yaml"
```

## 处理流程

1. **监控扫描**：每 10 秒扫描一次输入目录（仅第一层）
2. **视频入队**：发现新的 .mp4 文件自动加入处理队列
3. **串行处理**：严格按顺序处理，一次只处理一个视频
4. **分辨率识别**：根据视频分辨率自动识别视频类型（即梦/可灵）
5. **固定掩码**：加载对应类型的预生成精确掩码
6. **帧提取**：将视频拆分为帧序列
7. **并行修复**：使用 LaMa API 并行修复所有帧
8. **视频合成**：将修复后的帧合成为新视频（添加时间戳）
9. **清理完成**：删除原视频和中间文件，保留清理后的视频

## 处理策略

- **视频级串行**：确保系统稳定性，避免资源冲突
- **帧级并行**：提高处理效率，充分利用 API 并发能力
- **固定掩码**：基于视频分辨率自动选择预生成的精确掩码
- **类型识别**：支持即梦(832×1120)和可灵(1152×1760)两种视频类型
- **失败清理**：处理失败时自动清理工作目录，保留原视频
- **无断点续跑**：失败后重新开始，确保处理完整性

## 日志文件

程序运行日志保存在 `logs/app.log`，包含：
- 处理开始/结束时间
- 视频类型识别结果
- 使用的掩码文件路径
- 处理帧数和耗时
- 成功/失败状态
- 错误详情

## 注意事项

1. **确保 IOPaint 服务运行**：程序启动前必须先启动 IOPaint 服务
2. **FFmpeg 可用性**：确保 FFmpeg 和 FFprobe 在系统 PATH 中
3. **磁盘空间**：处理过程中需要足够的临时空间存储帧文件
4. **网络连接**：确保能够访问 IOPaint API 服务
5. **文件权限**：确保对输入/输出目录有读写权限

## 故障排除

### 1. FFmpeg 不可用
```
错误: FFmpeg 或 FFprobe 不可用
解决: 安装 FFmpeg 并添加到 PATH 环境变量
```

### 2. API 连接失败
```
错误: 无法连接到 IOPaint API
解决: 确保 IOPaint 服务已启动，检查端口和地址配置
```

### 3. 视频处理失败
```
错误: 视频处理失败
解决: 检查视频文件是否损坏，查看详细日志了解具体错误
```

### 4. 权限问题
```
错误: 无法创建输出目录
解决: 检查目录权限，确保程序有写入权限
```

## 性能优化

1. **调整并发数**：根据系统性能调整 `api_workers` 参数
2. **调整扫描间隔**：根据视频产生频率调整 `scan_interval_sec`
3. **使用 SSD**：将临时文件存储在 SSD 上可显著提高处理速度
4. **固定掩码**：跳过检测步骤，直接使用预生成掩码，大幅提升处理速度
5. **类型识别**：基于分辨率快速识别视频类型，无需复杂检测算法

## 固定掩码系统

### 支持的视频类型

| 视频类型 | 分辨率 | 掩码文件 | 水印位置 |
|---------|--------|----------|----------|
| 即梦 | 832×1120 | jimeng_mask.png | 左上角 + 右下角 |
| 可灵 | 1152×1760 | kling_mask.png | 左上角 + 右下角 |

### 掩码生成原理

1. **精确测量**：基于实际水印位置进行精确测量
2. **坐标映射**：根据视频分辨率计算精确坐标
3. **边距优化**：添加8像素边距确保完全覆盖
4. **预生成**：提前生成掩码文件，避免运行时计算

### 掩码坐标信息

#### 即梦视频掩码 (832×1120)：
- **左上角区域**：(8,2) → (108,58)
- **右下角区域**：(667,1052) → (823,1120)

#### 可灵视频掩码 (1152×1760)：
- **左上角区域**：(14,7) → (146,86)
- **右下角区域**：(926,1657) → (1136,1760)

### 类型识别机制

1. **分辨率检测**：使用 ffprobe 获取视频分辨率
2. **类型匹配**：与预定义的分辨率进行精确匹配
3. **掩码加载**：加载对应类型的掩码文件
4. **验证检查**：确保掩码尺寸与视频尺寸匹配

## 技术栈

- **Python 3.8+**
- **OpenCV**: 图像处理和掩码验证
- **NumPy**: 数值计算
- **Requests**: HTTP API 调用
- **FFmpeg**: 视频处理
- **IOPaint/LaMa**: AI 图像修复

## 处理时间估算

### 典型视频处理时间：

#### 即梦视频 (832×1120, 5秒, 121帧)：
- **帧提取**: ~2秒
- **帧修复**: ~30-60秒 (3并发)
- **视频合成**: ~3秒
- **总计**: ~35-65秒

#### 可灵视频 (1152×1760, 5秒, 153帧)：
- **帧提取**: ~3秒
- **帧修复**: ~40-80秒 (3并发)
- **视频合成**: ~4秒
- **总计**: ~47-87秒

### 性能优势：

- ✅ **跳过检测**: 无需抽帧和检测，直接处理
- ✅ **固定掩码**: 预生成掩码，加载速度快
- ✅ **类型识别**: 基于分辨率快速识别，毫秒级完成
- ✅ **并发处理**: LaMa API 支持多线程并行修复

## 许可证

本项目仅供学习和研究使用。
